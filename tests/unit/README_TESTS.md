# Документация по юнит-тестам для приложения AI.J.3.4

## Обзор
Этот документ описывает набор юнит-тестов, созданных для тестирования логики Flask-приложения `app.py`. Тесты написаны с использованием фреймворка `pytest` и фокусируются на функции `call_llm`, которая взаимодействует с внешним API AI-моделей.

## Структура тестов
Тесты расположены в файле `tests/unit/test_app.py` и разделены на два класса:
- `TestCallLLM`: Тесты для функции `call_llm`
- `TestIndexRoute`: Тесты для Flask-роута `index` (дополнительно для интеграции)

## Зависимости
Для запуска тестов установите следующие пакеты (уже добавлены в `requirements.txt`):
- `pytest==7.4.0`: Основной фреймворк для тестирования
- `pytest-mock==3.12.0`: Плагин для удобного мокирования

Установка:
```bash
pip install -r requirements.txt
```

## Запуск тестов
Из корневой директории проекта выполните:
```bash
pytest tests/unit/test_app.py
```

Для подробного вывода:
```bash
pytest tests/unit/test_app.py -v
```

Для запуска с покрытием (если установлен pytest-cov):
```bash
pytest tests/unit/test_app.py --cov=src
```

## Описание тестов

### TestCallLLM

#### 1. test_call_llm_success_worker_model
- **Цель**: Проверить успешный вызов API для Worker модели (перевод)
- **Mocking**: `requests.post` возвращает успешный ответ (200) с фиктивным переводом
- **Проверки**:
  - Функция возвращает текст из ответа API
  - `requests.post` вызывается с правильными параметрами
  - API ключ передается в заголовках авторизации

#### 2. test_call_llm_success_judge_model
- **Цель**: Проверить успешный вызов API для Judge модели (оценка)
- **Mocking**: Аналогично первому тесту, но с фиктивной оценкой
- **Проверки**: Аналогично первому тесту

#### 3. test_call_llm_api_key_missing
- **Цель**: Проверить обработку отсутствия API ключа в переменных окружения
- **Mocking**: `os.getenv` возвращает `None`
- **Проверки**:
  - Функция возвращает сообщение об ошибке
  - `requests.post` не вызывается

#### 4. test_call_llm_request_exception
- **Цель**: Проверить обработку сетевых ошибок
- **Mocking**: `requests.post` выбрасывает исключение
- **Проверки**:
  - Функция возвращает сообщение о сетевой ошибке
  - Исключение корректно перехватывается

#### 5. test_call_llm_api_error
- **Цель**: Проверить обработку ошибок API (неуспешный статус код)
- **Mocking**: `requests.post` возвращает ответ с статусом 401
- **Проверки**:
  - Функция возвращает сообщение об ошибке API с кодом и текстом

### TestIndexRoute

#### 1. test_index_post_success
- **Цель**: Проверить успешную обработку POST-запроса на главной странице
- **Mocking**: `call_llm` возвращает фиктивные перевод и оценку
- **Проверки**:
  - Роут возвращает успешный ответ (200)
  - HTML содержит результаты перевода и оценки
  - `call_llm` вызывается два раза

#### 2. test_index_get
- **Цель**: Проверить отображение формы на GET-запрос
- **Проверки**:
  - Роут возвращает успешный ответ
  - HTML содержит форму

## Изменения в основном коде
Для улучшения тестируемости были внесены следующие изменения в `src/app.py`:
1. Добавлен импорт `os` для работы с переменными окружения
2. В функции `call_llm` добавлена загрузка API ключа из `os.getenv('API_KEY')`
3. API ключ передается в заголовках запроса как `Authorization: Bearer {api_key}`
4. Добавлена проверка наличия API ключа перед отправкой запроса

Эти изменения позволяют:
- Тестировать логику загрузки конфиденциальных данных
- Избегать реальных API вызовов во время тестирования
- Обеспечивать безопасность (API ключ не хранится в коде)

## Лучшие практики тестирования
1. **Mocking**: Все внешние зависимости (HTTP-запросы, переменные окружения) замокаются
2. **Изоляция**: Каждый тест проверяет одну конкретную функциональность
3. **Читаемость**: Тесты содержат подробные комментарии и понятные имена
4. **Полнота**: Покрыты позитивные сценарии, ошибки и edge-кейсы
5. **Автоматизация**: Тесты можно запускать автоматически в CI/CD пайплайне

## Расширение тестов
В будущем можно добавить:
- Тесты для других моделей AI
- Тесты производительности
- Интеграционные тесты с реальным API (в отдельной среде)
- Тесты для шаблонов HTML
- Тесты безопасности (SQL injection, XSS и т.д.)

## Контакты
Если у вас есть вопросы по тестам или нужно внести изменения, обратитесь к QA Automation Lead.